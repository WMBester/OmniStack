trigger:
  - main

pool:
  vmImage: 'windows-latest'

steps:
- task: SonarCloudPrepare@2
  inputs:
    SonarCloud: 'SonarCloudServiceConnection' 
    organization: 'morneb'
    scannerMode: 'MSBuild'
    projectKey: 'Morneb_OmniStack'
    projectName: 'OmniStack'
    extraProperties: |
      sonar.scm.disabled=true

- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '8.0.x'

- script: dotnet restore
  displayName: 'Restore dependencies'

- script: dotnet build --configuration Release
  displayName: 'Build project'

- script: dotnet test --configuration Release --no-build --verbosity normal
  displayName: 'Run unit tests'

- script: |
    dotnet tool install -g dotnet-stryker
    dotnet stryker --project-file WMB.Api.Tests/WMB.Api.Tests.csproj --reporters "html;console" --threshold-break 80
  displayName: 'Run mutation tests with Stryker'

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: 'StrykerOutput'
    artifact: 'StrykerReport'
    publishLocation: 'pipeline'
  displayName: 'Publish Stryker mutation testing report'

- task: SonarCloudAnalyze@2

- task: SonarCloudPublish@2
  inputs:
    pollingTimeoutSec: '300'
