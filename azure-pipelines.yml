trigger:
  - '*'

variables:
  - group: SonarCloudSecrets
  - name: buildConfiguration
    value: 'Release'

pool:
  vmImage: 'windows-latest'

steps:
  # Install Java 17 (required by SonarCloud)
  - task: JavaToolInstaller@0
    inputs:
      versionSpec: '17'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'
    displayName: 'Install Java 17'

  # Install .NET 8 SDK
  - task: UseDotNet@2
    inputs:
      packageType: 'sdk'
      version: '8.0.x'
    displayName: 'Install .NET 8 SDK'

  # Add .NET global tools path to PATH
  - powershell: |
      $dotnetTools = "$env:USERPROFILE\.dotnet\tools"
      Write-Host "##vso[task.prependpath]$dotnetTools"
    displayName: 'Add dotnet global tools path to PATH'

  # Install SonarScanner CLI
  - script: |
      dotnet tool install --global dotnet-sonarscanner
    displayName: 'Install SonarScanner CLI'
    env:
      DOTNET_ROOT: $(Agent.ToolsDirectory)/dotnet
      PATH: $(Agent.ToolsDirectory)/dotnet;$(USERPROFILE)\.dotnet\tools;$(PATH)

  # SonarCloud Begin Analysis
  - script: |
      dotnet sonarscanner begin /k:"Morneb_OmniStack" /o:"morneb" /d:sonar.login="$(SONAR_TOKEN)" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.scm.disabled=true /d:sonar.scanner.skipJreProvisioning=true /d:sonar.cs.opencover.reportsPaths="WMB.Api.Tests/TestResults/coverage.opencover.xml" /d:sonar.exclusions="WMB.Api.Tests/**,k6-tests/**,azure-pipelines.yml"
    displayName: 'SonarCloud Begin Analysis'
    env:
      DOTNET_ROOT: $(Agent.ToolsDirectory)/dotnet
      PATH: $(Agent.ToolsDirectory)/dotnet;$(USERPROFILE)\.dotnet\tools;$(PATH)

  # Restore projects
  - script: |
      dotnet restore OmniStack.sln
    displayName: 'Restore projects'

  # Build projects
  - script: |
      dotnet build OmniStack.sln --configuration $(buildConfiguration)
    displayName: 'Build projects'

  # Run tests with OpenCover coverage
  - script: |
      dotnet test OmniStack.sln --configuration $(buildConfiguration) --no-build --verbosity normal /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:CoverletOutput=WMB.Api.Tests/TestResults/coverage.opencover.xml
    displayName: 'Run tests with coverage'
    env:
      DOTNET_ROOT: $(Agent.ToolsDirectory)/dotnet
      PATH: $(Agent.ToolsDirectory)/dotnet;$(USERPROFILE)\.dotnet\tools;$(PATH)

  # Optional: List generated files for debugging
  - powershell: |
      Write-Host "Files in TestResults:"
      Get-ChildItem -Path "$(Build.SourcesDirectory)/WMB.Api.Tests/TestResults" -Recurse
    displayName: 'Debug: List coverage files'

  # SonarCloud End Analysis
  - script: |
      dotnet sonarscanner end /d:sonar.login="$(SONAR_TOKEN)"
    displayName: 'SonarCloud End Analysis'
    env:
      DOTNET_ROOT: $(Agent.ToolsDirectory)/dotnet
      PATH: $(Agent.ToolsDirectory)/dotnet;$(USERPROFILE)\.dotnet\tools;$(PATH)

  # Publish Code Coverage Results (UI integration)
  - task: PublishCodeCoverageResults@2
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: 'WMB.Api.Tests/TestResults/coverage.opencover.xml'
      reportDirectory: 'WMB.Api.Tests/TestResults'
      failIfCoverageEmpty: true
    displayName: 'Publish Code Coverage Results'

  # Run Mutation Tests with Stryker
  - script: |
      dotnet tool install --global dotnet-stryker
      dotnet stryker --solution ../OmniStack.sln --reporter html --reporter progress --threshold-high 80 --threshold-low 60
    displayName: 'Run mutation tests with Stryker'
    workingDirectory: 'WMB.Api.Tests'
    env:
      DOTNET_ROOT: $(Agent.ToolsDirectory)/dotnet
      PATH: $(Agent.ToolsDirectory)/dotnet;$(USERPROFILE)\.dotnet\tools;$(PATH)

  # Publish Stryker HTML Report
  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: 'WMB.Api.Tests/StrykerOutput'
      artifact: 'StrykerReport'
      publishLocation: 'pipeline'
    displayName: 'Publish Stryker mutation testing report'
