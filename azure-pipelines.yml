trigger:
  - '*'

variables:
  - group: SonarCloudSecrets
  - name: buildConfiguration
    value: 'Release'

pool:
  vmImage: 'windows-latest'

steps:
# Install Java 17 (required by SonarCloud)
- task: JavaToolInstaller@0
  inputs:
    versionSpec: '17'
    jdkArchitectureOption: 'x64'
    jdkSourceOption: 'PreInstalled'
  displayName: 'Install Java 17'

# Install .NET 8 SDK
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '8.0.x'
  displayName: 'Install .NET 8 SDK'

# Add .NET global tools path to PATH (for SonarScanner & Stryker)
- powershell: |
    $dotnetTools = "$env:USERPROFILE\.dotnet\tools"
    Write-Host "##vso[task.prependpath]$dotnetTools"
  displayName: 'Add dotnet global tools path to PATH'

# Install SonarScanner CLI & Run SonarCloud Analysis
- script: |
    dotnet tool install --global dotnet-sonarscanner
    echo "##vso[task.prependpath]$HOME/.dotnet/tools"
    dotnet sonarscanner begin /k:"Morneb_OmniStack" /o:"morneb" /d:sonar.login="$(SONAR_TOKEN)" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.scm.disabled=true /d:sonar.scanner.skipJreProvisioning=true /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml"
    dotnet restore OmniStack.sln
    dotnet build OmniStack.sln --configuration $(buildConfiguration)
    dotnet test OmniStack.sln --configuration $(buildConfiguration) --no-build --verbosity normal /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:CoverletOutput=./TestResults/
    dotnet sonarscanner end /d:sonar.login="$(SONAR_TOKEN)"
  displayName: 'Install SonarScanner CLI and Run SonarCloud Analysis'

# Run Mutation Tests with Stryker
- script: |
    dotnet tool install --global dotnet-stryker
    dotnet stryker --project WMB.Api.Tests/WMB.Api.Tests.csproj --reporter html --reporter progress --threshold-high 80 --threshold-low 60
  displayName: 'Run mutation tests with Stryker'

# Publish Stryker HTML Report
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: 'StrykerOutput'
    artifact: 'StrykerReport'
    publishLocation: 'pipeline'
  displayName: 'Publish Stryker mutation testing report'
