trigger:
  - '*'

variables:
  - group: SonarCloudSecrets
  - name: buildConfiguration
    value: Release
  - name: coverageOutputPath
    value: '$(Build.SourcesDirectory)/WMB.Api.Tests/TestResults/coverage.opencover.xml'

pool:
  vmImage: windowsâ€‘latest

steps:
# â”€â”€ Tooling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- task: JavaToolInstaller@0
  inputs:
    versionSpec: '17'
    jdkArchitectureOption: x64
    jdkSourceOption: PreInstalled
  displayName: InstallÂ JavaÂ 17

- task: UseDotNet@2
  inputs:
    packageType: sdk
    version: 8.0.x
  displayName: InstallÂ .NETÂ 8Â SDK

- pwsh: |
    Writeâ€‘Host "##vso[task.prependpath]$env:USERPROFILE\.dotnet\tools"
  displayName: AddÂ dotnetÂ toolsÂ toÂ PATH

# â”€â”€ Restore & Build once (BEFORE tests) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- script: dotnet restore OmniStack.sln
  displayName: RestoreÂ projects

# â”€â”€ SonarCloud begin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- script: dotnet tool install -g dotnet-sonarscanner
  displayName: InstallÂ SonarScannerÂ CLI

- script: |
    dotnet sonarscanner begin `
      /k:"Morneb_OmniStack" `
      /o:"morneb" `
      /d:sonar.login="$(SONAR_TOKEN)" `
      /d:sonar.host.url="https://sonarcloud.io" `
      /d:sonar.cs.opencover.reportsPaths="$(coverageOutputPath)" `
      /d:sonar.scm.disabled=true `
      /d:sonar.scanner.skipJreProvisioning=true `
      /d:sonar.exclusions="**/WMB.Api.Tests/**/*,**/k6-tests/**/*,**/*.yml"
  displayName: SonarÂ Begin
  env:
    SONAR_TOKEN: $(SONAR_TOKEN)

- script: dotnet build OmniStack.sln --configuration $(buildConfiguration)
  displayName: BuildÂ solution

# â”€â”€ Test + coverage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- script: >
    dotnet test OmniStack.sln
    --configuration $(buildConfiguration)
    --no-build
    /p:CollectCoverage=true
    /p:CoverletOutputFormat=opencover
    /p:CoverletOutput=$(coverageOutputPath)
  displayName: RunÂ testsÂ withÂ coverage

# â”€â”€ SonarCloud end â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- script: dotnet sonarscanner end /d:sonar.login="$(SONAR_TOKEN)"
  displayName: SonarÂ End
  env:
    SONAR_TOKEN: $(SONAR_TOKEN)

# â”€â”€ Publish coverage to the â€œCode coverageâ€ tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- task: PublishCodeCoverageResults@2
  displayName: PublishÂ coverage
  inputs:
    codeCoverageTool: Cobertura
    summaryFileLocation: '$(coverageOutputPath)'
    reportDirectory: '$(Build.SourcesDirectory)/WMB.Api.Tests/TestResults'
    failIfCoverageEmpty: true

# â”€â”€ Stryker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- script: |
    dotnet tool install -g dotnet-stryker
    dotnet stryker --solution ../OmniStack.sln ^
                   --reporter html --reporter progress ^
                   --output StrykerOutput ^
                   --threshold-high 80 --threshold-low 60
  workingDirectory: WMB.Api.Tests
  displayName: RunÂ StrykerÂ mutationÂ tests

# â”€â”€ Publish the HTML report & light up the â€œMutationÂ Reportâ€ tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   ğŸ‘‰ task name exactly as shown in the extension docs:
#      https://marketplace.visualstudio.com/items?itemName=stryker-mutator.mutation-report-publisher
- task: PublishMutationReport@1
  displayName: PublishÂ StrykerÂ MutationÂ Report
  inputs:
    reportPattern: 'WMB.Api.Tests/StrykerOutput/mutation-report.html'
    reportDisplayName: 'MutationÂ TestingÂ (Â StrykerÂ )'

